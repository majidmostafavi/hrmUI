<p-panel>
  <p-panel header="جستجو" [toggleable]="true">
    <table>
      <tr>
        <td>سال</td>
        <td>&nbsp;</td>
        <td>
          <p-select
            [options]="years"
            [(ngModel)]="selectedYear"
            name="year"
            [checkmark]="true"
            optionLabel="name"
            [showClear]="true"
            placeholder="انتخاب سال"
            class="w-full md:w-56"
          />
        </td>
        <td>&nbsp;</td>
        <td>ماه</td>
        <td>&nbsp;</td>
        <td>
          <p-multiselect
            [options]="months"
            [(ngModel)]="selectedMonths"
            name="month"
            optionLabel="name"
            placeholder="انتخاب ماه"
            class="w-full md:w-56"
          />
        </td>
        <td>&nbsp;</td>
        <td>سازمان</td>
        <td>&nbsp;</td>
        <td>
          @for ( organization of organizations; track organization.id){
          <div class="flex items-center">
            <p-checkbox
              [inputId]="organization.name"
              name="group"
              (onChange)="addReportSearch($event, organization)"
              [value]="organization"
              [(ngModel)]="selectedOrganizations"
            />
            <label [for]="organization.name" class="ml-2">
              {{ organization.name }}
            </label>
          </div>
          }
        </td>
        <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td>
          @for (search of reportSearchList;track search.organizationID) {
          <div class="flex items-center">
            {{ search.yearName }}/{{ search.organizationName }}/
            <button
              pButton
              [rounded]="true"
              [text]="true"
              severity="danger"
              value="save"
              icon="pi pi-trash"
              (click)="deleteReportSearch(search)"
            ></button>
          </div>
          }
        </td>
      </tr>
    </table>

    <button
      pButton
      [rounded]="true"
      [text]="true"
      severity="info"
      value="save"
      icon="pi pi-search"
      (click)="search()"
    ></button>
  </p-panel>
  <p-table
    [value]="personnelAttendanceReportList"
    [scrollable]="true"
    stripedRows
    [tableStyle]="{ 'min-width': '50rem' }"
  >
    <ng-template #header>
      <!-- ردیف اول: گروه‌بندی اصلی -->
      <tr>
        <th
          rowspan="2"
          pSortableColumn="occupation.name"
          class="vertical-middle"
        >
          <div>
            شغل
            <p-sortIcon field="occupation.name" />
          </div>
        </th>
        @for (item of reportSearchList; track item.months) {
        <th colspan="3" class="group-header">
          <div class="header-group-content">
            <div class="organization-name">{{ item.organizationName }}</div>
            <div class="period-info">
              {{ item.yearName }}
            </div>
          </div>
        </th>
        }
      </tr>

      <!-- ردیف دوم: ستون‌های جزئیات -->
      <tr>
        @for (item of reportSearchList; track item.months) {
        <th class="sub-header">تعداد پرسنل حاضر</th>
        <th class="sub-header">اضافه کار بدون ضریب</th>
        <th class="sub-header">اضافه کار با ضریب</th>
        }
      </tr>
    </ng-template>

    <ng-template #body let-personAttendanceReport>
      <tr>
        <td>{{ personAttendanceReport.occupationName }}</td>
        @for (searchItem of reportSearchList; track searchItem.months; let i =
        $index) { @if (personAttendanceReport.reportDetail &&
        personAttendanceReport.reportDetail[i]) {
        <td>{{ personAttendanceReport.reportDetail[i].attendanceCount }}</td>
        <td>
          {{ personAttendanceReport.reportDetail[i].overtimeTotalWorked }}
        </td>
        <td>
          {{ personAttendanceReport.reportDetail[i].overtimeWithMultiplier }}
        </td>
        } @else {
        <td>0</td>
        <td class="time-display">0:00</td>
        <td class="time-display">0:00</td>
        } }
      </tr>
    </ng-template>

    <ng-template #footer>
      <tr>
        <td colspan="1" class="text-right font-bold p-1 pb-0">مجموع</td>
        @for (item of reportSearchList; track item.months; let i = $index) {
        <td class="font-bold p-1 pb-0">
          {{ calculateAttendanceTotalByIndex(i) }}
        </td>
        <td class="font-bold p-1 pb-0 time-display">
          {{ calculateOvertimeTotalByIndex(i) }}
        </td>
        <td class="font-bold p-1 pb-0 time-display">
          {{ calculateOvertimeWithMultiplierTotalByIndex(i) }}
        </td>
        }
      </tr>
    </ng-template>
  </p-table>
</p-panel>
