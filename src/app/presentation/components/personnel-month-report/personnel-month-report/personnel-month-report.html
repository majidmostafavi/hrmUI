<p-panel>
  <p-panel header="جستجو" [toggleable]="true">
    <table>
      <tr>
        <td>سال</td>
        <td>
          <p-select
            [options]="years"
            [(ngModel)]="selectedYear"
            name="year"
            [checkmark]="true"
            optionLabel="name"
            [showClear]="true"
            placeholder="انتخاب سال"
            class="w-full md:w-56"
          />
        </td>

        <td>ماه</td>
        <td>
          <p-select
            [options]="months"
            [(ngModel)]="selectedMonth"
            name="month"
            [checkmark]="true"
            optionLabel="name"
            [showClear]="true"
            placeholder="انتخاب ماه"
            class="w-full md:w-56"
          />
        </td>

        <td>سازمان</td>
        <td>
          <p-select
            [options]="organizations"
            [(ngModel)]="selectedOrganization"
            name="organization"
            [checkmark]="true"
            optionLabel="name"
            [showClear]="true"
            placeholder="انتخاب سازمان"
            class="w-full md:w-56"
          />
        </td>
        <td></td>
        <td>
          <button
            pButton
            [rounded]="true"
            [text]="true"
            severity="success"
            value="save"
            icon="pi pi-plus"
            (click)="addReportSearch()"
          ></button>
        </td>
      </tr>
    </table>
    <p-table [value]="reportSearchList">
      <ng-template #header>
        <tr>
          <th>واحد</th>
          <th>سال</th>
          <th>ماه</th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-searchDTO>
        <tr>
          <td>{{ searchDTO.organizationName }}</td>
          <td>{{ searchDTO.yearName }}</td>
          <td>{{ searchDTO.monthName }}</td>

          <td>
            <button
              pButton
              [rounded]="true"
              [text]="true"
              severity="danger"
              value="save"
              icon="pi pi-trash"
              (click)="deleteReportSearch(searchDTO)"
            ></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
    <button
      pButton
      [rounded]="true"
      [text]="true"
      severity="info"
      value="save"
      icon="pi pi-search"
      (click)="search()"
    ></button>
  </p-panel>
  <p-table
    [value]="personnelAttendanceReportList"
    [scrollable]="true"
    scrollHeight="50vh"
    stripedRows
    [tableStyle]="{ 'min-width': '50rem' }"
  >
    <ng-template #header>
      <!-- ردیف اول: گروه‌بندی اصلی -->
      <tr>
        <th
          rowspan="2"
          pSortableColumn="occupation.name"
          class="vertical-middle"
        >
          <div>
            شغل
            <p-sortIcon field="occupation.name" />
          </div>
        </th>
        @for (item of reportSearchList; track item.monthID) {
        <th colspan="3" class="group-header">
          <div class="header-group-content">
            <div class="organization-name">{{ item.organizationName }}</div>
            <div class="period-info">
              {{ item.yearName }}
            </div>
          </div>
        </th>
        }
      </tr>

      <!-- ردیف دوم: ستون‌های جزئیات -->
      <tr>
        @for (item of reportSearchList; track item.monthID) {
        <th class="sub-header">تعداد پرسنل حاضر</th>
        <th class="sub-header">اضافه کار بدون ضریب</th>
        <th class="sub-header">اضافه کار با ضریب</th>
        }
      </tr>
    </ng-template>

    <ng-template #body let-personAttendanceReport>
      <tr>
        <td>{{ personAttendanceReport.occupation.name }}</td>
        @for (searchItem of reportSearchList; track searchItem.monthID; let i =
        $index) { @if (personAttendanceReport.reportDetail &&
        personAttendanceReport.reportDetail[i]) {
        <td>{{ personAttendanceReport.reportDetail[i].attendanceCount }}</td>
        <td class="time-display">
          {{
            formatTimeDisplay(
              personAttendanceReport.reportDetail[i].overtimeTotalWorked
            )
          }}
        </td>
        <td class="time-display">
          {{
            formatTimeDisplay(
              personAttendanceReport.reportDetail[i].overtimeWithMultiplier
            )
          }}
        </td>
        } @else {
        <td>0</td>
        <td class="time-display">0:00</td>
        <td class="time-display">0:00</td>
        } }
      </tr>
    </ng-template>

    <ng-template #footer>
      <tr>
        <td colspan="1" class="text-right font-bold p-1 pb-0">مجموع</td>
        @for (item of reportSearchList; track item.monthID; let i = $index) {
        <td class="font-bold p-1 pb-0">
          {{ calculateAttendanceTotalByIndex(i) }}
        </td>
        <td class="font-bold p-1 pb-0 time-display">
          {{ calculateOvertimeTotalByIndex(i) }}
        </td>
        <td class="font-bold p-1 pb-0 time-display">
          {{ calculateOvertimeWithMultiplierTotalByIndex(i) }}
        </td>
        }
      </tr>
    </ng-template>
  </p-table>
</p-panel>
