<p-panel header="جستجو" [toggleable]="true">
  <table>
    <tr>
      <td>سال : </td>
      <td>
        @for ( year of years; track year.id){
          <div class="field-checkbox">
            <p-radiobutton [inputId]="year.name" name="year" [value]="year" [(ngModel)]="selectedYear" />
            <label [for]="year.name" class="ml-2">{{ year.name }}</label>
          </div>
        }
      </td>

      <td>ماه : </td>
      <td>
        <p-multiselect
          [options]="months"
          [(ngModel)]="selectedMonths"
          name="month"
          optionLabel="name"
          placeholder="انتخاب ماه"
          class="w-full md:w-56"
        />
      </td>
      <td></td>
    </tr>
    <tr>
      <td>سازمان : </td>
      <td>
        @for ( organization of organizations; track organization.id){
        <div class="flex items-center">
          <p-checkbox [inputId]="organization.name" name="group"
                      (onChange)="addReportSearch($event, organization)"
                      [value]="organization" [(ngModel)]="selectedOrganizations" />
          <label [for]="organization.name" class="ml-2"> {{ organization.name }} </label>
        </div>
        }
      </td>
      <td>

      </td>
<td>
  @for (search of reportSearchList;track search.organizationID) {
    <div class="flex items-center">
          {{search.yearName}}/{{search.organizationName}}/ <button
      pButton
      [rounded]="true"
      [text]="true"
      severity="danger"
      value="save"
      icon="pi pi-trash"
      (click)="deleteReportSearch(search)"
    ></button>
    </div>
    }
</td>
    </tr>
  </table>
</p-panel>

<p-tabs
  value="0"
  [(value)]="selectedTab"
  (valueChange)="onTabChange(selectedTab)"
>
  <p-tablist>
    <p-tab value="0"> خدمات به کل نیروانسانی</p-tab>
    <p-tab value="1">خدمات به گروه بندی</p-tab>
    <p-tab value="2">خدمات به نیروی پشتیبانی</p-tab>
  </p-tablist>
  <p-tabpanels>
    <p-tabpanel value="0">
      <!-- چارت‌های جدید (دو ستونه - کنار هم) -->
      @if (chartDataWithoutOvertime) {
      <div class="charts-container mt-6">
        <!-- نمایش جدول خلاصه -->
        <div class="summary-table">
          <h4>خلاصه آماری</h4>
          <table>
            <thead>
              <tr>
                <th>درخواست</th>
                <th>مجموع بدون اضافه‌کاری</th>
                <th>مجموع با اضافه‌کاری</th>
              </tr>
            </thead>
            <tbody>
              @for (lbl of chartDataWithoutOvertime.labels; track $index) {
              <tr>
                <td>{{ $index + 1 }}. {{ lbl }}</td>
                <td>
                  {{ getTotalForLabelIndex($index, "count").toFixed(2) }}
                </td>
                <td>
                  {{ getTotalForLabelIndex($index, "countWith").toFixed(2) }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="charts-grid">
          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - بدون اضافه‌کاری</h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithoutOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - با اضافه‌کاری</h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- جدول داده‌ها -->
      <p-table
        stripedRows
        [value]="ratioServiceResList">
        <ng-template #header>

          <tr>
            <th rowspan="3"> خدمت </th>
          </tr>

              <tr>
                @for(item of reportSearchList; track item){
                      <th colspan="2">{{item.organizationName}} - {{item.yearName}} </th>
                }
              </tr>

              <tr>
                @for (item of reportSearchList; track item){
                <th>بدون اضافه کار</th>
                <th>با اضافه کار</th>
                }
              <tr>

        </ng-template>
        <ng-template #body let-ratioServiceRes>
          <tr>
            <td>
              {{ ratioServiceRes.categoryCode }}-{{
                ratioServiceRes.categoryName
              }}
            </td>
            @for (item of ratioServiceRes.ratioServiceResDetailWrappers; track
            item){
            <td>{{ item.count }}</td>
            <td>{{ item.countWith }}</td>
            }
          </tr>
        </ng-template>
      </p-table>
    </p-tabpanel>

    <p-tabpanel value="1">
      <!-- چارت‌های جدید برای تب دوم (دو ستونه - کنار هم) -->
      @if (chartDataWithoutOvertime) {
      <div class="charts-container mt-6">
        <!-- نمایش جدول خلاصه -->
        <div class="summary-table">
          <h4>خلاصه آماری</h4>
          <table>
            <thead>
              <tr>
                <th>درخواست</th>
                <th>مجموع بدون اضافه‌کاری</th>
                <th>مجموع با اضافه‌کاری</th>
              </tr>
            </thead>
            <tbody>
              @for (lbl of chartDataWithoutOvertime.labels; track $index) {
              <tr>
                <td>{{ lbl }}</td>
                <td>
                  {{ getTotalForLabelIndex($index, "count").toFixed(2) }}
                </td>
                <td>
                  {{ getTotalForLabelIndex($index, "countWith").toFixed(2) }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="charts-grid">
          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - بدون اضافه‌کاری</h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithoutOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - با اضافه‌کاری</h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- همان محتوای تب اول -->
      <p-table
        stripedRows [value]="ratioServiceResList">
        <ng-template #header>
          <tr>
            <th rowspan="3"> خدمت </th>
          </tr>

          <tr>
            @for(item of reportSearchList; track item){
                  <th colspan="2">{{item.organizationName}} - {{item.yearName}} </th>
            }
          </tr>

          <tr>
            @for (item of reportSearchList; track item){
              <th>بدون اضافه کار</th>
              <th>با اضافه کار</th>
            }
          <tr>
        </ng-template>
        <ng-template #body let-ratioServiceRes>
          <tr>
            <td>
              {{ ratioServiceRes.categoryCode }}-{{
                ratioServiceRes.categoryName
              }}
            </td>
            @for (item of ratioServiceRes.ratioServiceResDetailWrappers; track
            item){
            <td>{{ item.count }}</td>
            <td>{{ item.countWith }}</td>
            }
          </tr>
        </ng-template>
      </p-table>
    </p-tabpanel>

    <p-tabpanel value="2">
      <!-- چارت‌های جدید برای تب سوم (دو ستونه - کنار هم) -->
      @if (chartDataWithoutOvertime) {
      <div class="charts-container mt-6">
        <!-- نمایش جدول خلاصه -->
        <div class="summary-table">
          <h4>خلاصه آماری</h4>
          <table>
            <thead>
              <tr>
                <th>درخواست</th>
                <th>مجموع بدون اضافه‌کاری</th>
                <th>مجموع با اضافه‌کاری</th>
              </tr>
            </thead>
            <tbody>
              @for (lbl of chartDataWithoutOvertime.labels; track $index) {
              <tr>
                <td>{{ lbl }}</td>
                <td>
                  {{ getTotalForLabelIndex($index, "count").toFixed(2) }}
                </td>
                <td>
                  {{ getTotalForLabelIndex($index, "countWith").toFixed(2) }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="charts-grid">
          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - بدون اضافه‌کاری </h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithoutOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>

          <div class="chart-wrapper">
            <div class="chart-header">
              <h3>گزارش خدمات - با اضافه‌کاری </h3>
              <p class="chart-subtitle">توزیع خدمات به تفکیک سازمان</p>
            </div>
            <div class="chart-content">
              <p-chart
                type="bar"
                [data]="chartDataWithOvertime"
                [options]="chartOptions"
                class="h-[30rem]"
              >
              </p-chart>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- همان محتوای تب اول -->
      <p-table  stripedRows
                [value]="ratioServiceResList">
        <ng-template #header>
          <tr>
            <th rowspan="3"> خدمت </th>
          </tr>

          <tr>
            @for(item of reportSearchList; track item){
              <th colspan="2">{{item.organizationName}} - {{item.yearName}} - @for (month of item.months; track month.id){ {{ month.name }}/}</th>
            }
          </tr>

          <tr>
            @for (item of reportSearchList; track item){
              <th>بدون اضافه کار</th>
              <th>با اضافه کار</th>
            }
          <tr>
        </ng-template>
        <ng-template #body let-ratioServiceRes>
          <tr>
            <td>
              {{ ratioServiceRes.categoryCode }}-{{
                ratioServiceRes.categoryName
              }}
            </td>
            @for (item of ratioServiceRes.ratioServiceResDetailWrappers; track
            item){
            <td>{{ item.count }}</td>
            <td>{{ item.countWith }}</td>
            }
          </tr>
        </ng-template>
      </p-table>
    </p-tabpanel>
  </p-tabpanels>
</p-tabs>
